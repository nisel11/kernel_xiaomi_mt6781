dist: bionic

language: c

notifications:
 - email: true

before_script:
 # Download the kernel
 - sudo apt-get install libelf-dev wget tar gzip python
 - wget https://mirrors.edge.kernel.org/pub/linux/kernel/v4.x/linux-4.1.36.tar.gz
 - tar xf linux-4.1.36.tar.gz
 - mv linux-4.1.36 linux-stable
 - ./.travis_get_mainline_kernel
 - cp ./.travis_cmd_wrapper.pl ~/travis_cmd_wrapper.pl
 # Prerequisite for xfstests testing
 - sudo apt-get install linux-headers-$(uname -r)
 - sudo apt-get install autoconf libtool pkg-config libnl-3-dev libnl-genl-3-dev
 - sudo apt-get install xfslibs-dev uuid-dev libtool-bin xfsprogs libgdbm-dev gawk fio attr libattr1-dev libacl1-dev libaio-dev
 - git clone --branch=exfat-next https://github.com/exfat-utils/exfat-utils
 - export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
 - export PATH=/usr/local/lib:$PATH
 - sudo useradd fsgqa
 - sudo useradd 123456-fsgqa

script:
 # Copy ksmbd source to kernel
 - mv linux-stable ../
 - mv linux ../
 - mkdir ../linux-stable/fs/exfat
 - cp -ar * ../linux-stable/fs/exfat/
 - mkdir ../linux/fs/exfat
 - cp -ar * ../linux/fs/exfat/

 # Compile with 4.1 kernel
 - cd ../linux-stable
 - yes "" | make oldconfig > /dev/null
 - echo 'obj-$(CONFIG_EXFAT_FS) += exfat/' >> fs/Makefile
 - echo 'source "fs/exfat/Kconfig"' >> fs/Kconfig
 - echo 'CONFIG_EXFAT_FS=m' >> .config
 - make -j$((`nproc`+1)) fs/exfat/exfat.ko

 # Compile with latest Torvalds' kernel
 - cd ../linux
 - yes "" | make oldconfig > /dev/null
 - echo 'obj-$(CONFIG_EXFAT) += exfat/' >> fs/Makefile
 - echo 'source "fs/exfat/Kconfig"' >> fs/Kconfig
 - echo 'CONFIG_EXFAT_FS=m' >> .config
 - make -j$((`nproc`+1)) fs/exfat/exfat.ko

 # Run xfstests testsuite
 - cd ../exfat
 - make > /dev/null
 - sudo make install > /dev/null
 - sudo modprobe exfat
 - cd exfat-utils
 - ./autogen.sh > /dev/null
 - ./configure > /dev/null
 - make -j$((`nproc`+1)) > /dev/null
 - sudo make install > /dev/null
 - cd ..
 - sudo mkdir -p /mnt/scratch
 - sudo mkdir -p /mnt/test
 - dd if=/dev/zero bs=1024 count=1024000 of=test.img
 - dd if=/dev/zero bs=1024 count=1024000 of=scratch.img
 - mkfs.exfat test.img
 - mkfs.exfat scratch.img
 - cd exfat-testsuites/
 - tar xzvf xfstests-exfat.tgz > /dev/null
 - cd xfstests-exfat
 - ./configure > /dev/null
 - make -j$((`nproc`+1)) > /dev/null
 - sudo ./check generic/001
 - sudo ./check generic/002
 - sudo ./check generic/005
 - sudo ./check generic/006
 - sudo ./check generic/007
